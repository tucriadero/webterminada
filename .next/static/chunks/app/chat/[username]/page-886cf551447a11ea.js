(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[562],{4285:function(e,t,s){Promise.resolve().then(s.bind(s,9364))},9364:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return l}});var r=s(7437),n=s(2265),i=s(1774),a=s(2141),u=s(9376);let o=["\uD83D\uDC4D","❤️","\uD83D\uDE02","\uD83D\uDE2E","\uD83D\uDE22"];function l(){let e=(0,i.useUser)(),{username:t}=(0,u.useParams)(),[s,l]=(0,n.useState)([]),[c,d]=(0,n.useState)(""),[m,p]=(0,n.useState)(null),[f,x]=(0,n.useState)(null),[h,g]=(0,n.useState)(!1),v=(0,n.useRef)(null),b=(0,n.useRef)(null),w=(0,n.useRef)(null);(0,n.useEffect)(()=>{if(!e||!t)return;(async()=>{let{data:s}=await a.O.from("profiles").select("id").eq("username",t).single();if(!s)return;w.current=s.id;let{data:r}=await a.O.from("messages").select("*").or("sender_id.eq.".concat(e.id,",receiver_id.eq.").concat(e.id)).in("sender_id",[e.id,s.id]).in("receiver_id",[e.id,s.id]).order("inserted_at");if(r){l(r);let t=r.filter(t=>t.receiver_id===e.id&&!t.read);if(t.length>0){let e=t.map(e=>e.id);await a.O.from("messages").update({read:!0}).in("id",e)}}})();let s=a.O.channel("chat-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},e=>{l(t=>[...t,e.new])}).subscribe(),r=a.O.channel("typing-".concat(t)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"typing_status",filter:"user_id=eq.".concat(w.current)},t=>{t.new.target_id===e.id&&g(t.new.typing)}).subscribe();return()=>{a.O.removeChannel(s),a.O.removeChannel(r)}},[e,t]),(0,n.useEffect)(()=>{var e;null===(e=v.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[s]);let _=async()=>{if(!c.trim()&&!m||!e||!w.current)return;let t=null;if(m){let s="".concat(e.id,"/").concat(Date.now(),"-").concat(m.name),{error:r}=await a.O.storage.from("chat").upload(s,m);r||(t=s)}await a.O.from("messages").insert({sender_id:e.id,receiver_id:w.current,content:c||null,image_url:t,read:!1,reacciones:[]}),d(""),p(null),a.O.from("typing_status").upsert({user_id:e.id,target_id:w.current,typing:!1,updated_at:new Date().toISOString()})},S=async(t,s)=>{let{data:r}=await a.O.from("messages").select("reacciones").eq("id",t).single(),n=[...((null==r?void 0:r.reacciones)||[]).filter(t=>t.user_id!==(null==e?void 0:e.id)),{emoji:s,user_id:e.id}];await a.O.from("messages").update({reacciones:n}).eq("id",t),l(e=>e.map(e=>e.id===t?{...e,reacciones:n}:e)),x(null)};return(0,r.jsxs)("div",{className:"min-h-screen bg-[#DFF6EA] p-4 max-w-2xl mx-auto flex flex-col",children:[(0,r.jsxs)("h1",{className:"text-xl font-bold text-[#5cae97] mb-1",children:["Conversaci\xf3n con @",t]}),h&&(0,r.jsx)("p",{className:"text-sm text-gray-500 mb-2 italic",children:"Est\xe1 escribiendo…"}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-3 mb-4",children:[s.map(t=>{var s;return(0,r.jsxs)("div",{className:"relative max-w-xs px-4 py-2 rounded-2xl shadow text-sm break-words whitespace-pre-wrap cursor-pointer group ".concat(t.sender_id===(null==e?void 0:e.id)?"bg-[#5cae97] text-white self-end ml-auto":"bg-white text-gray-800 self-start mr-auto"),onContextMenu:e=>{e.preventDefault(),x(t.id)},children:[t.content&&(0,r.jsx)("p",{children:t.content}),t.image_url&&(0,r.jsx)("img",{src:"https://cinsudwupbiqqizvqwij.supabase.co/storage/v1/object/public/chat/".concat(t.image_url),alt:"imagen",className:"rounded-xl mt-2 max-w-[200px]"}),(0,r.jsx)("p",{className:"text-xs text-gray-400 mt-1 text-right",children:new Date(t.inserted_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}),(null===(s=t.reacciones)||void 0===s?void 0:s.length)>0&&(0,r.jsx)("div",{className:"mt-1 flex gap-1",children:t.reacciones.map((e,t)=>(0,r.jsx)("span",{className:"text-sm",children:e.emoji},t))}),f===t.id&&(0,r.jsx)("div",{className:"absolute -top-10 left-1/2 -translate-x-1/2 bg-white border rounded-full shadow p-1 flex gap-1 z-10",children:o.map(e=>(0,r.jsx)("button",{onClick:()=>S(t.id,e),className:"text-xl hover:scale-110 transition",children:e},e))})]},t.id)}),(0,r.jsx)("div",{ref:v})]}),(0,r.jsxs)("div",{className:"bg-white p-3 rounded-xl shadow flex items-center gap-2",children:[(0,r.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var t;return p((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)},className:"text-sm"}),(0,r.jsx)("input",{value:c,onChange:t=>{d(t.target.value),e&&w.current&&(a.O.from("typing_status").upsert({user_id:e.id,target_id:w.current,typing:!0,updated_at:new Date().toISOString()}),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{a.O.from("typing_status").upsert({user_id:e.id,target_id:w.current,typing:!1,updated_at:new Date().toISOString()})},2e3))},placeholder:"Escribe un mensaje",className:"flex-1 border rounded-full px-4 py-2 text-sm"}),(0,r.jsx)("button",{onClick:_,className:"bg-[#5cae97] text-white rounded-full px-4 py-2 text-sm hover:bg-[#4c9c85]",children:"Enviar"})]})]})}},2141:function(e,t,s){"use strict";s.d(t,{O:function(){return r}});let r=(0,s(6580).eI)("https://cinsudwupbiqqizvqwij.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpbnN1ZHd1cGJpcXFpenZxd2lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0ODQ3MTIsImV4cCI6MjA2ODA2MDcxMn0.NL4RoZ3dPWllHaJfK37WtPtu-6NTNJ-DRJrs6MAY8E0")},1774:function(e,t,s){"use strict";var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,a=Object.prototype.hasOwnProperty,u=(e,t,s)=>new Promise((r,n)=>{var i=e=>{try{u(s.next(e))}catch(e){n(e)}},a=e=>{try{u(s.throw(e))}catch(e){n(e)}},u=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,a);u((s=s.apply(e,t)).next())}),o={};((e,t)=>{for(var s in t)r(e,s,{get:t[s],enumerable:!0})})(o,{SessionContextProvider:()=>m,useSession:()=>x,useSessionContext:()=>p,useSupabaseClient:()=>f,useUser:()=>h}),e.exports=((e,t,s,u)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of i(t))a.call(e,s)||void 0===s||r(e,s,{get:()=>t[s],enumerable:!(u=n(t,s))||u.enumerable});return e})(r({},"__esModule",{value:!0}),o);var l=s(2265),c=s(7437),d=(0,l.createContext)({isLoading:!0,session:null,error:null,supabaseClient:{}}),m=({supabaseClient:e,initialSession:t=null,children:s})=>{let[r,n]=(0,l.useState)(t),[i,a]=(0,l.useState)(!t),[o,m]=(0,l.useState)();(0,l.useEffect)(()=>{!r&&t&&n(t)},[r,t]),(0,l.useEffect)(()=>{let t=!0;return function(){u(this,null,function*(){let{data:{session:s},error:r}=yield e.auth.getSession();if(t){if(r){m(r),a(!1);return}n(s),a(!1)}})}(),()=>{t=!1}},[]),(0,l.useEffect)(()=>{let{data:{subscription:t}}=e.auth.onAuthStateChange((e,t)=>{t&&("SIGNED_IN"===e||"TOKEN_REFRESHED"===e||"USER_UPDATED"===e)&&n(t),"SIGNED_OUT"===e&&n(null)});return()=>{t.unsubscribe()}},[]);let p=(0,l.useMemo)(()=>i?{isLoading:!0,session:null,error:null,supabaseClient:e}:o?{isLoading:!1,session:null,error:o,supabaseClient:e}:{isLoading:!1,session:r,error:null,supabaseClient:e},[i,r,o]);return(0,c.jsx)(d.Provider,{value:p,children:s})},p=()=>{let e=(0,l.useContext)(d);if(void 0===e)throw Error("useSessionContext must be used within a SessionContextProvider.");return e};function f(){let e=(0,l.useContext)(d);if(void 0===e)throw Error("useSupabaseClient must be used within a SessionContextProvider.");return e.supabaseClient}var x=()=>{let e=(0,l.useContext)(d);if(void 0===e)throw Error("useSession must be used within a SessionContextProvider.");return e.session},h=()=>{var e,t;let s=(0,l.useContext)(d);if(void 0===s)throw Error("useUser must be used within a SessionContextProvider.");return null!=(t=null==(e=s.session)?void 0:e.user)?t:null}},9376:function(e,t,s){"use strict";var r=s(5475);s.o(r,"useParams")&&s.d(t,{useParams:function(){return r.useParams}}),s.o(r,"useRouter")&&s.d(t,{useRouter:function(){return r.useRouter}}),s.o(r,"useSearchParams")&&s.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[580,971,117,744],function(){return e(e.s=4285)}),_N_E=e.O()}]);